%include "TiberianSun.inc"
%include "macros/patch.inc"

;;; This fixes a trick where one playerA can block another playerB's refinery
;;; by unilaterally allying playerB and using Alt to force a playerA harvester
;;; into the playerB's refinery bay. Additionally if playerA continually allies
;;; multiple times the harvester could explode and destroy the refinery
;;; In the function Can_Enter_Cell, Is_Ally is only checked in one direction. 
_UnitClass__Can_Enter_Cell__Test_for_Mutual_ally:
hack 0x006559A2, 0x006559A8
        mov     eax, [ebx+0ECh]
        mov     ecx, [esi+0ECh]
        push    eax
        call    0x004BDA20      ; HouseClass__Is_Ally

        test    al, al
        jz      0x006559D3

        mov     edx, [esi]
        lea     eax, [esp+06Ch]
        jmp     hackend
